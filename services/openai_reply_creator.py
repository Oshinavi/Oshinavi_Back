import os
from openai import AsyncOpenAI
from dotenv import load_dotenv

SYSTEM_PROMPT_TEMPLATE = """
ã‚ãªãŸã¯ã€ã‚¢ã‚¤ãƒ‰ãƒ«ã®ãƒ•ã‚¡ãƒ³ã¨ã—ã¦ã€Xï¼ˆæ—§Twitterï¼‰ã§ãƒªãƒ—ãƒ©ã‚¤ã‚’é€ã‚‹AIã§ã™ã€‚
ç›¸æ‰‹ã¯æ—¥æœ¬ã®å¥³æ€§ã‚¢ã‚¤ãƒ‰ãƒ«ã§ã€æ—¥å¸¸ã®æŠ•ç¨¿ã‚„ãŠçŸ¥ã‚‰ã›ï¼ˆæ”¾é€ãƒ»ãƒ©ã‚¤ãƒ–ãƒ»ã‚°ãƒƒã‚ºãªã©ï¼‰ã‚’Xã«æŠ•ç¨¿ã—ã¦ã„ã¾ã™ã€‚

ã‚ãªãŸã®å½¹å‰²ã¯ã€ãƒ•ã‚¡ãƒ³ã¨ã—ã¦è‡ªç„¶ã§ä¸å¯§ãªæ—¥æœ¬èªã§ãƒªãƒ—ãƒ©ã‚¤ã‚’é€ã‚‹ã“ã¨ã§ã™ã€‚

æ¬¡ã®ãƒ«ãƒ¼ãƒ«ã«å¾“ã£ã¦ãã ã•ã„ï¼š
- æŠ•ç¨¿å†…å®¹ãŒæ—¥å¸¸çš„ãªæŒ¨æ‹¶ï¼ˆä¾‹ï¼šãŠã¯ã‚ˆã†ã€ã“ã‚“ã«ã¡ã¯ï¼‰ãªã‚‰ã€åŒã˜ã‚ˆã†ãªæŒ¨æ‹¶ï¼‹å¿œæ´ã®æ°—æŒã¡ã‚’è¾¼ã‚ãŸä¸€è¨€ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚
- æŠ•ç¨¿ãŒæ´»å‹•ã«é–¢ã™ã‚‹ãŠçŸ¥ã‚‰ã›ï¼ˆä¾‹ï¼šæ”¾é€ã€ãƒ©ã‚¤ãƒ–ã€ã‚°ãƒƒã‚ºç™ºå£²ï¼‰ãªã‚‰ã€ã€Œæ¥½ã—ã¿ã«ã—ã¦ã„ã¾ã™ã€ã€Œå¿œæ´ã—ã¦ã„ã¾ã™ã€ã€Œé ãã‹ã‚‰ã§ã‚‚è¦‹å®ˆã£ã¦ã¾ã™ã€ãªã©ã®å¿œæ´ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ·»ãˆã¦ãã ã•ã„ã€‚
- ãƒ•ã‚¡ãƒ³ã¨ã—ã¦ã®ç«‹å ´ã‚’å®ˆã‚Šã€ã‚¢ã‚¤ãƒ‰ãƒ«ã«å¤±ç¤¼ã®ãªã„ã‚ˆã†ã«ä¸å¯§ãªè¨€è‘‰ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚
- çµµæ–‡å­—ã¯ã‚ã£ã¦ã‚‚1ã€œ2å€‹ã¾ã§ã€‚ç„¡ç†ã«ä½¿ã†å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
- å¿…ãšæ—¥æœ¬èªã§è¿”ç­”ã—ã¦ãã ã•ã„ã€‚
- ç”Ÿæˆã•ã‚Œã‚‹è¿”ä¿¡ã®æ–‡å­—æ•°ã¯æœ€å¤§280ãƒã‚¤ãƒˆã¾ã§ã«ã—ã¦ãã ã•ã„ã€‚
"""


# .env ê²½ë¡œì§€ì • ë° openai api key ë§ˆìš´íŠ¸
BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
ENV_PATH = os.path.join(BASE_DIR, "config", "settings.env")
load_dotenv(dotenv_path=ENV_PATH)
api_key = os.getenv("OPENAI_API_KEY")

# OpenAI í´ë¼ì´ì–¸íŠ¸
client = AsyncOpenAI(api_key=api_key)


async def reply_generator(tweet_text: str) -> str:
    try:
        response = await client.chat.completions.create(
            model="gpt-4o-mini-2024-07-18",
            messages=[
                {"role": "system", "content": SYSTEM_PROMPT_TEMPLATE},
                {"role": "user", "content": tweet_text.strip()}
            ],
            temperature=0.5
        )

        reply_text = response.choices[0].message.content.strip()
        print(f"ìƒì„±ëœ ë¦¬í”Œë¼ì´: {reply_text}")
        return reply_text

    except Exception as e:
        print(f"ì˜¤ë¥˜ ë°œìƒ: {e}")
        return "ë¦¬í”Œë¼ì´ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."

# async def test_reply_generation():
#     # ì‹¤ì œ í…ŒìŠ¤íŠ¸ìš© íŠ¸ìœ— (ì¼ë³¸ì–´)
#     test_tweets = [
#         "ğŸŒ±ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ã€€30000äººğŸŒ±ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™â€¦!! ã—ã‹ã‚‚ãƒ‡ãƒ“ãƒ¥ãƒ¼1å‘¨å¹´ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã€ã‚‚ã†ä¸€ã¤ãŠç¥ã„äº‹ãŒå¢—ãˆã¦ã¨ã¦ã‚‚å¬‰ã—ã„ã§ã™ğŸ¥° ã€Œè‘‰å±±é¢¨èŠ±ã€ã®ã“ã¨ã‚’ã‚‚ã£ã¨ãŸãã•ã‚“ã®æ–¹ã«çŸ¥ã£ã¦ã„ãŸã ã‘ã‚‹ã‚ˆã†ã«ã€ã“ã‚Œã‹ã‚‰ã‚‚å°½åŠ›ã—ã¦å‚ã‚Šã¾ã™ï¼ å¼•ãç¶šãã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ï¼",
#         "105æœŸãŒã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã—ãŸğŸª· ç§ã¯å¤‰ã‚ã‚‰ãšå°éˆ´ã¡ã‚ƒã‚“ã®ã™ããã°ã§ã€å°éˆ´ã¡ã‚ƒã‚“ã‚’å®ˆã‚Šã€ä¸€ç·’ã«æˆé•·ã§ããŸã‚‰ã¨æ€ã£ã¦ãŠã‚Šã¾ã™ï¼ è“®ãƒç©ºå¥³å­¦é™¢ã‚¹ã‚¯ãƒ¼ãƒ«ã‚¢ã‚¤ãƒ‰ãƒ«ã‚¯ãƒ©ãƒ–ã§ã®æ´»å‹•ã‚’å¼•ãç¶šãå¿œæ´ã—ã¦ã„ãŸã ã‘ã¾ã™ã¨å¹¸ã„ã§ã™ã€‚ ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ï¼",
#     ]
#
#     for tweet in test_tweets:
#         print(f"\nğŸ“ ã‚¢ã‚¤ãƒ‰ãƒ«ã®ãƒ„ã‚¤ãƒ¼ãƒˆ: {tweet}")
#         reply = await reply_generator(tweet)
#         print(f"ğŸ’¬ ãƒ•ã‚¡ãƒ³ã®ãƒªãƒ—ãƒ©ã‚¤: {reply}")
#
# # ë¹„ë™ê¸° ì‹¤í–‰
# if __name__ == "__main__":
#     asyncio.run(test_reply_generation())